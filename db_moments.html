<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html> <head>
     <title>Apophenia: a library for scientific computing</title>

<!-- Google is watching. -->
<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-134313-2";
urchinTracker();
</script>


     <link rel="stylesheet" href="typical.css" type="text/css" >
     <script  type="text/javascript" language="JavaScript" src="tree.js"></script>
</head><body>
     <center><table cellpadding=10pt>
     <tr> <td><img width=140px src=flake.gif alt="Patterns in static"></td> 
    <td><table>
     	<tr> <td><center><h2><a href="http://apophenia.info">Apophenia</a></h2></center></td></tr>
<tr><td><div class="qindex"><a class="qindex" href="index.html">&nbsp;Intro</a> | <a class="qindex" href="outline.html">Outline</a> | <a class="qindex" href="globals.html">Index</a> <!--| <a class="qindex" href="files.html">File&nbsp;List&nbsp;</a> -->  </div></td></tr></table>
	</td></tr></table></center>

    <div> <!--Doxygen generates an extra </div>.-->
<!-- Generated by Doxygen 1.7.6.1 -->
</div>
<div class="header">
  <div class="headertitle">
<div class="title">Database moments (plus pow()!) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>SQLite lets users define new functions for use in queries, and Apophenia uses this facility to define a few common functions.</p>
<ul>
<li><code>select ran() from table</code> will produce a new random number between zero and one for every row of the input table, using <code>gsl_rng_uniform</code>.</li>
</ul>
<ul>
<li>The SQL standard includes the <code>count(x)</code> and <code>avg(x)</code> aggregators, but statisticians are usually interested in higher moments as well---at least the variance. Therefore, SQL queries using the Apophenia library may include any of these moments:</li>
</ul>
<div class="fragment"><pre class="fragment">select count(x), stddev(x), avg(x), var(x), variance(x), skew(x), kurt(x), kurtosis(x),
std(x), stddev_samp(x), stddev_pop(x), var_samp(x), var_pop(x)
from table
group by whatever
</pre></div><p><code>var</code> and <code>variance</code>; <code>kurt</code> and <code>kurtosis</code> do the same thing. Choose the one that sounds better to you. <code>var</code>, <code>var_samp</code>, <code>stddev</code> and <code>stddev_samp</code> give sample variance/standard deviation; <code>variance</code>, <code>var_pop</code> <code>std</code> and <code>stddev_pop</code> give population standard deviation. The plethora of variants are for mySQL compatibility.</p>
<ul>
<li>The var/skew/kurtosis functions calculate sample moments, so if you want the population moment, multiply the result by (n-1)/n .</li>
</ul>
<ul>
<li>For bonus points, there are the <code>sqrt(x)</code>, <code>pow(x,y)</code>, <code>exp(x)</code>, <code>log(x)</code>, and trig functions. They call the standard math library function of the same name to calculate <img class="formulaInl" alt="$\sqrt{x}$" src="form_11.png"/>, <img class="formulaInl" alt="$x^y$" src="form_12.png"/>, <img class="formulaInl" alt="$e^x$" src="form_13.png"/>, <img class="formulaInl" alt="$\ln(x)$" src="form_14.png"/>, <img class="formulaInl" alt="$\sin(x)$" src="form_15.png"/>, <img class="formulaInl" alt="$\arcsin(x)$" src="form_16.png"/>, et cetera.</li>
</ul>
<ul>
<li>The random() function keepts its own <code>gsl_rng</code>, which is intialized on first call using the value of <code>apop_ots.rng_seed</code> (which is then incremented, so the next function to use it will get a different seed).</li>
</ul>
<div class="fragment"><pre class="fragment">select sqrt(x), pow(x,0.5), exp(x), log(x), 
    sin(x), cos(x), tan(x), asin(x), acos(x), atan(x)
from table
</pre></div><p>Here is a test script using many of the above.</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;apop.h&gt;</span>

<span class="preprocessor">#define Diff(L, R) assert(fabs((L)-(R)&lt;1e-4));</span>
<span class="preprocessor"></span><span class="preprocessor">#define getrow(rowname) apop_data_get(row, .colname=#rowname)</span>
<span class="preprocessor"></span>
<span class="keywordtype">double</span> test_all(<a class="code" href="structapop__data.html">apop_data</a> *row){
    Diff(gsl_pow_2(getrow(root)), getrow(rr))
    Diff(getrow(ln), getrow(l10)*log(10))
    Diff(getrow(rr), getrow(rragain))
    Diff(getrow(one), 1)
    return 0;
}

<span class="keywordtype">int</span> main(){
    <span class="comment">//create a table with two rows.</span>
    <span class="comment">//We didn&#39;t explicitly open a db with apop_db_open,</span>
    <span class="comment">//so this will be an in-memory SQLite db.</span>
    <a class="code" href="group__queries.html#ga236452b3305ea7b791c781d91a819e3b">apop_query</a>(<span class="stringliteral">&quot;create table a(b); &quot;</span>
               <span class="stringliteral">&quot;insert into a values(1); &quot;</span>
               <span class="stringliteral">&quot;insert into a values(1); &quot;</span>

                <span class="stringliteral">&quot;create table randoms as &quot;</span>
                <span class="stringliteral">&quot;select ran() as rr &quot;</span>
                <span class="comment">/* join to create 2^13=8192 rows*/</span>
                <span class="stringliteral">&quot;from a,a,a,a,a,a,a,a,a,a,a,a,a;&quot;</span>);
    <a class="code" href="structapop__data.html">apop_data</a> *d = <a class="code" href="group__queries.html#gade862993166c6482f53562fb77721db9">apop_query_to_data</a>(
            <span class="stringliteral">&quot;select rr, sqrt(rr) as root, &quot;</span>
            <span class="stringliteral">&quot;log(rr) as ln, log10(rr) as l10, &quot;</span>
            <span class="stringliteral">&quot;exp(log(rr)) as rragain, &quot;</span>
            <span class="stringliteral">&quot;pow(sin(rr),2)+pow(cos(rr),2) as one &quot;</span>
            <span class="stringliteral">&quot;from randoms&quot;</span>);
    <a class="code" href="group__mapply.html#gaacff3707e418a067104c77c410b43f69">apop_map</a>(d, .fn_r=test_all);

    <span class="comment">//the pop variance of a Uniform[0,1]=1/12; kurtosis=1/80.</span>
    <a class="code" href="stats_8h.html#afdacf526f18ea8c5bd16bd2572e5d4b3">Apop_col_t</a>(d, <span class="stringliteral">&quot;rr&quot;</span>, rrow);
    Diff(<a class="code" href="group__vector__moments.html#gacc311abe133963c7959162a7d3d83fb8">apop_var</a>(rrow)*8191./8192., 1/12. );
    Diff(<a class="code" href="group__vector__moments.html#gaf5740c698174b1a265d182f4af1c0252">apop_vector_kurtosis</a>(rrow)*8191./8192., 1/80.);<span class="comment">//approx.</span>

    Diff(<a class="code" href="group__queries.html#ga1ad75f9dfba696a3741e28896ed5b75d">apop_query_to_float</a>(<span class="stringliteral">&quot;select stddev(rr) from randoms&quot;</span>), 
                sqrt(1/12.)*8192./8191);
}
</pre></div><p>Here is some more realistic sample code:</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;apop.h&gt;</span>

<span class="keywordtype">int</span> main(){
    <a class="code" href="apop__db_8c.html#a7975faa07196cf463ec261ff0ddc3ccc">apop_opts</a>.<a class="code" href="structapop__opts__type.html#a9c128a43c2e53c7639ce4ddb0cef92f6">db_engine</a>=<span class="charliteral">&#39;s&#39;</span>; <span class="comment">//SQLite only.</span>
    <a class="code" href="group__queries.html#ga236452b3305ea7b791c781d91a819e3b">apop_query</a>(<span class="stringliteral">&quot;create table atab (a numeric)&quot;</span>);
    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt; 1e5; i++)
        <a class="code" href="group__queries.html#ga236452b3305ea7b791c781d91a819e3b">apop_query</a>(<span class="stringliteral">&quot;insert into atab values(ran())&quot;</span>);
    <a class="code" href="group__queries.html#ga236452b3305ea7b791c781d91a819e3b">apop_query</a>(<span class="stringliteral">&quot;create table powa as &quot;</span>
            <span class="stringliteral">&quot;select a, pow(a, 2) as sq, pow(a, 0.5) as sqrt &quot;</span>
            <span class="stringliteral">&quot;from atab&quot;</span>);

    <span class="comment">//compare the std dev of a uniform as reported by the </span>
    <span class="comment">//database routine, the matrix routine, and math.</span>
    <span class="keywordtype">double</span> db_pop_stddev = <a class="code" href="group__queries.html#ga1ad75f9dfba696a3741e28896ed5b75d">apop_query_to_float</a>(<span class="stringliteral">&quot;select stddev_pop(a) from powa&quot;</span>);
    <a class="code" href="structapop__data.html">apop_data</a> *d = <a class="code" href="group__queries.html#gade862993166c6482f53562fb77721db9">apop_query_to_data</a>(<span class="stringliteral">&quot;select * from powa&quot;</span>);
    <a class="code" href="structapop__data.html">apop_data</a> *cov = <a class="code" href="apop__stats_8c.html#aeae37a5bf11cddee59e272b083a4efc7">apop_data_covariance</a>(d);
    <span class="keywordtype">double</span> matrix_pop_stddev = sqrt(<a class="code" href="group__data__set__get.html#gae3c2f0d4bd96555e8eeb32a44511d0ac">apop_data_get</a>(cov)*(d-&gt;matrix-&gt;size1/(d-&gt;matrix-&gt;size1-1.)));
    assert(fabs(db_pop_stddev - matrix_pop_stddev) &lt; 1e-4);
    <span class="keywordtype">double</span> actual_stddev = sqrt(2*gsl_pow_3(.5)/3);
    assert(fabs(db_pop_stddev - actual_stddev) &lt; 1e-3);

    <span class="keywordtype">float</span> sq_mean = <a class="code" href="group__queries.html#ga1ad75f9dfba696a3741e28896ed5b75d">apop_query_to_float</a>(<span class="stringliteral">&quot;select avg(sq) from powa&quot;</span>);
    <span class="keywordtype">float</span> actual_sq_mean = 1./3;
    assert(fabs(sq_mean - actual_sq_mean) &lt; 1e-3);

    <span class="keywordtype">float</span> sqrt_mean = <a class="code" href="group__queries.html#ga1ad75f9dfba696a3741e28896ed5b75d">apop_query_to_float</a>(<span class="stringliteral">&quot;select avg(sqrt) from powa&quot;</span>);
    <span class="keywordtype">float</span> actual_sqrt_mean = 2./3;
    assert(fabs(sqrt_mean - actual_sqrt_mean) &lt; 1e-3);
}
</pre></div> </div></div><!-- contents -->
<p><p>
<div class="tiny">Autogenerated by doxygen on Fri May 17 2013.</div></body></html>
